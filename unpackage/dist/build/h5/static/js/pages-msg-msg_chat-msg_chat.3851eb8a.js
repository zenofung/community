(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["pages-msg-msg_chat-msg_chat"],{2909:function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=r;var a=u(s("6005")),n=u(s("db90")),i=u(s("06c5")),o=u(s("3427"));function u(t){return t&&t.__esModule?t:{default:t}}function r(t){return(0,a.default)(t)||(0,n.default)(t)||(0,i.default)(t)||(0,o.default)()}},3427:function(t,e,s){"use strict";function a(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}Object.defineProperty(e,"__esModule",{value:!0}),e.default=a},"5a09":function(t,e,s){"use strict";var a=s("7b05"),n=s.n(a);n.a},6005:function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=i;var a=n(s("6b75"));function n(t){return t&&t.__esModule?t:{default:t}}function i(t){if(Array.isArray(t))return(0,a.default)(t)}},"7b05":function(t,e,s){var a=s("d7a1");"string"===typeof a&&(a=[[t.i,a,""]]),a.locals&&(t.exports=a.locals);var n=s("4f06").default;n("1a9b0910",a,!0,{sourceMap:!1,shadowMode:!1})},a887:function(t,e,s){"use strict";var a;s.d(e,"b",(function(){return n})),s.d(e,"c",(function(){return i})),s.d(e,"a",(function(){return a}));var n=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("v-uni-view",[s("v-uni-scroll-view",{staticClass:"cu-chat contentbottoms"},t._l(t.message,(function(e){return s("v-uni-view",{key:e.magId},[0==e.messageUser?s("v-uni-view",{staticClass:"cu-item self"},[s("v-uni-view",{staticClass:"main"},[null!=e.msgStatus?s("v-uni-view",{staticClass:"cu-info",on:{click:function(s){arguments[0]=s=t.$handleEvent(s),t.sendMessage2(e.magContent)}}},[s("v-uni-text",{staticClass:"cuIcon-roundclosefill text-red "}),t._v("点击重新发送")],1):t._e(),s("v-uni-view",{staticClass:"content bg-green shadow"},[s("v-uni-text",[t._v(t._s(e.magContent))])],1)],1),s("v-uni-view",{staticClass:"cu-avatar radius",style:{"background-image":"url("+e.userVo.userProtrait+")"}}),s("v-uni-view",{staticClass:"date"},[t._v(t._s(t.timestampFormat(e.createTime)))])],1):t._e(),0!=e.messageUser?s("v-uni-view",{staticClass:"cu-item"},[s("v-uni-view",{staticClass:"cu-avatar radius",style:{"background-image":"url("+e.userVo.userProtrait+")"}}),s("v-uni-view",{staticClass:"main"},[s("v-uni-view",{staticClass:"content shadow"},[s("v-uni-text",[t._v(t._s(e.magContent))])],1)],1),s("v-uni-view",{staticClass:"date "},[t._v(t._s(t.timestampFormat(e.createTime)))])],1):t._e()],1)})),1),s("v-uni-view",{staticClass:"cu-bar foot input",style:[{bottom:t.InputBottom+"px"}]},[s("v-uni-view",{staticClass:"action"},[s("v-uni-text",{staticClass:"cuIcon-sound text-grey"})],1),s("v-uni-input",{staticClass:"solid-bottom",attrs:{"adjust-position":!1,focus:!1,maxlength:"300","cursor-spacing":"10",value:t.context},on:{focus:function(e){arguments[0]=e=t.$handleEvent(e),t.InputFocus.apply(void 0,arguments)},input:function(e){arguments[0]=e=t.$handleEvent(e),t.textChange.apply(void 0,arguments)},blur:function(e){arguments[0]=e=t.$handleEvent(e),t.InputBlur.apply(void 0,arguments)}}}),s("v-uni-view",{staticClass:"action"},[s("v-uni-text",{staticClass:"cuIcon-emojifill text-grey"})],1),s("v-uni-button",{staticClass:"cu-btn bg-green shadow",on:{click:function(e){arguments[0]=e=t.$handleEvent(e),t.sendMessage()}}},[t._v("发送")])],1)],1)},i=[]},aded:function(t,e,s){"use strict";s("e25e"),Object.defineProperty(e,"__esModule",{value:!0}),e.articleUtil=void 0;var a={timestampFormat:function(t){if(!t)return"";t=new Date(t).getTime()/1e3;function e(t){return(1==String(t).length?"0":"")+t}var s=parseInt((new Date).getTime()/1e3),a=s-t,n=new Date(1e3*s),i=new Date(1e3*t),o=i.getFullYear(),u=i.getMonth()+1,r=i.getDate(),c=i.getHours(),l=i.getMinutes();i.getSeconds();if(a<60)return"刚刚";if(a<3600)return Math.floor(a/60)+"分钟前";if(n.getFullYear()==o&&n.getMonth()+1==u&&n.getDate()==r)return"今天"+e(c)+":"+e(l);var d=new Date(1e3*(s-86400));return d.getFullYear()==o&&d.getMonth()+1==u&&d.getDate()==r?"昨天"+e(c)+":"+e(l):n.getFullYear()==o?e(u)+"月"+e(r)+"日 "+e(c)+":"+e(l):o+"年"+e(u)+"月"+e(r)+"日 "+e(c)+":"+e(l)},clickThumbsup:function(t,e){var s=this;this.$set(this.$data.article.commentEntity[e],"praiseStatus",!this.$data.article.commentEntity[e].praiseStatus),this.$data.article.commentEntity[e].praiseStatus&&this.$myRequest({url:"/commentpraise/save",method:"post",data:{userId:this.$user.id,commentId:t}}).then((function(t){0==t.data.code&&s.$set(s.$data.article.commentEntity[e],"praises",s.$data.article.commentEntity[e].praises+1)})),this.$data.article.commentEntity[e].praiseStatus||this.$myRequest({url:"/commentpraise/delete",method:"post",data:{userId:this.$user.id,commentId:t}}).then((function(t){0==t.data.code&&s.$set(s.$data.article.commentEntity[e],"praises",s.$data.article.commentEntity[e].praises-1)})),console.log(this.$data.article.commentEntity[e].praiseStatus),console.log("childThumbsup")}};e.articleUtil=a},b834:function(t,e,s){"use strict";s("d3b7"),Object.defineProperty(e,"__esModule",{value:!0}),e.login=n,e.quit=o,e.onSocketMessage=i,e.sendSocketMessage=u;var a=null;function n(t){var e={status:1,content:{id:t,content:"login"}},s={status:"0"};return uni.connectSocket({url:"wss://www.homiesocial.cn/webSocket"}),uni.onSocketOpen((function(t){a=setInterval((function(){u(s)}),6e3),u(e)})),Promise.resolve("ok")}function i(){uni.onSocketMessage((function(t){return JSON.parse(t.data)}))}function o(){uni.onSocketClose((function(t){clearInterval(a),a=null,console.log("WebSocket 已关闭！")}))}function u(t){return uni.sendSocketMessage({data:JSON.stringify(t)})}},c539:function(t,e,s){"use strict";var a=s("4ea4");s("26e9"),s("ac1f"),Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var n=a(s("2909")),i=s("aded"),o=s("b834"),u={data:function(){return{listFlag:!1,page:1,totalPage:0,hei:0,InputBottom:0,message:[],scrollH:0,context:"",imMagListId:"",user:{status:2,content:{userId:"",targetId:"login",magContent:"",imMagListId:"",messageUser:0}}}},mounted:function(){""==window.name?(console.log("首次被加载"),window.name="isRefresh"):"isRefresh"==window.name&&console.log("页面被刷新"),this.scrollToBottom()},methods:{scrollToBottom:function(){var t=this;this.$nextTick((function(){uni.createSelectorQuery().select(".cu-chat").boundingClientRect((function(e){t.scrollH=e.height,console.log(t.scrollH),uni.pageScrollTo({duration:100,scrollTop:t.scrollH})})).exec()}))},sendMessage:function(){var t=this;console.log("发送消息",this.$data.user);var e={userId:this.$data.user.content.userId,targetId:this.$data.user.content.targetId,magContent:this.$data.context,imMagListId:this.$data.user.content.imMagListId,userVo:this.$data.user.content.userVo,messageUser:0};this.$data.user.content.magContent=this.$data.context,console.log("发送内容",this.$data.user);JSON.stringify(this.$data.user);(0,o.sendSocketMessage)(this.$data.user).then((function(s){null!=s[0]&&(console.log("重新连接",s),e.msgStatus=1,(0,o.login)(t.$user.id))})),console.log("push内容",e),this.$data.message.push(e),this.context="",this.scrollToBottom()},sendMessage2:function(t){console.log("发送消息",t);var e={userId:this.$data.user.content.userId,targetId:this.$data.user.content.targetId,magContent:t,imMagListId:this.$data.user.content.imMagListId,userVo:this.$data.user.content.userVo,messageUser:0};this.$data.user.content.magContent=t,console.log("发送内容",this.$data.user);JSON.stringify(this.$data.user);(0,o.sendSocketMessage)(this.$data.user).then((function(t){null!=t[0]&&(console.log("重新连接",t),e.msgStatus=1)})),console.log("push内容",e),this.$data.message.push(e),this.context="",this.scrollToBottom()},textChange:function(t){var e=t.detail.value;this.sendState=null==e||""==e||void 0==e,this.context=t.detail.value},InputFocus:function(t){this.InputBottom=t.detail.height},InputBlur:function(t){this.InputBottom=0},timestampFormat:function(t){return i.articleUtil.timestampFormat(t)}},onUnload:function(){console.log("聊天页面关闭"),uni.$off("message")},onPullDownRefresh:function(){var t=this;setTimeout((function(){uni.stopPullDownRefresh()}),200),console.log("上拉刷新"),this.totalPage<this.page+1?uni.showToast({title:"暂无更多",icon:"none",duration:850}):(this.page=this.page+1,this.$myRequest({url:"/immessage/list/",methed:"get",data:{limit:20,page:this.page,imList:this.imMagListId,userId:this.$user.id}}).then((function(e){var s;e.data.page.list.length<20&&(t.listFlag=!0);var a=e.data.page.list.reverse();if(console.log(a),(s=t.message).unshift.apply(s,(0,n.default)(a)),e.data.page.list.length<20){t.listFlag=!0;var i=e.data.page.list.length;console.log(100*i),t.$nextTick((function(){uni.createSelectorQuery().select(".cu-chat").boundingClientRect((function(t){uni.pageScrollTo({duration:0,scrollTop:i})})).exec()}))}else t.$nextTick((function(){uni.createSelectorQuery().select(".cu-chat").boundingClientRect((function(e){console.log(e.height),uni.pageScrollTo({duration:0,scrollTop:t.scrollH}),t.scrollH=e.height})).exec()}))})))},destroyed:function(){this.$myRequest({url:"/immessage/updateMessageStatus",methed:"get",data:{msgList:this.imMagListId,userId:this.$user.id}}).then((function(t){})),console.log("destroyed")},onLoad:function(t){var e=this,s=this;s.$data.user.content.userId=this.$user.userId,uni.$on("message",(function(t){console.log("监听函数接收",t),t.imMagListId==e.imMagListId&&(s.$data.message.push(t),e.scrollToBottom())})),null!=t&&(console.log(t.data),this.imMagListId=t.data,this.$myRequest({url:"/immessage/list/",methed:"get",data:{limit:20,page:1,imList:t.data,userId:this.$user.id}}).then((function(t){e.message=t.data.page.list.reverse(),console.log(e.message),e.totalPage=t.data.page.totalPage,e.scrollToBottom()})),this.$myRequest({url:"/immessagelist/info/"+t.data,methed:"get",data:{userId:this.$user.id}}).then((function(t){e.$data.user.content.userId=e.$user.id,e.$user.id==t.data.imMessageList.userId?e.$data.user.content.targetId=t.data.imMessageList.friendId:e.$data.user.content.targetId=t.data.imMessageList.userId,e.$data.user.content.imMagListId=t.data.imMessageList.id,e.$data.user.content.userVo=t.data.imMessageList.userVo,console.log("通道信息",e.$data.user.content)})))}};e.default=u},d7a1:function(t,e,s){var a=s("24fb");e=a(!1),e.push([t.i,"uni-page-body[data-v-123e3510]{padding-bottom:%?100?%}.contentbottoms[data-v-123e3510]{padding-bottom:calc(var(--window-bottom) + 20px)}",""]),t.exports=e},db90:function(t,e,s){"use strict";function a(t){if("undefined"!==typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}s("a4d3"),s("e01a"),s("d28b"),s("a630"),s("d3b7"),s("3ca3"),s("ddb0"),Object.defineProperty(e,"__esModule",{value:!0}),e.default=a},dde1:function(t,e,s){"use strict";s.r(e);var a=s("c539"),n=s.n(a);for(var i in a)"default"!==i&&function(t){s.d(e,t,(function(){return a[t]}))}(i);e["default"]=n.a},e130:function(t,e,s){"use strict";s.r(e);var a=s("a887"),n=s("dde1");for(var i in n)"default"!==i&&function(t){s.d(e,t,(function(){return n[t]}))}(i);s("5a09");var o,u=s("f0c5"),r=Object(u["a"])(n["default"],a["b"],a["c"],!1,null,"123e3510",null,!1,a["a"],o);e["default"]=r.exports}}]);